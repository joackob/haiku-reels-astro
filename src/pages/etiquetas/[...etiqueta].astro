---
import EstructuraBaseParaTodoElSitio from "@layouts/estructura-base-para-todo-el-sitio.astro";
import EstructuraParaEfectoReel from "@layouts/estructura-principal-para-efecto-reel-ignorado-por-motor-de-busqueda.astro";
import SeccionParaCadaHaikuReel from "@layouts/seccion-para-cada-tarjeta-reel.astro";
import ArticuloParaCadaHaiku from "@components/articulo-para-cada-haiku/index.astro";
import BgOrigamis from "@backgrounds/bg-origamis/index.astro";
import BgJ from "@backgrounds/bg-j/index.astro";
import BgTemplo from "@backgrounds/bg-templo/index.astro";
import BgLamparas from "@backgrounds/bg-lampara/index.astro";
import BgTanuki from "@backgrounds/bg-tanuki/index.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import type { GetStaticPaths } from "astro";
import { render } from "astro:content";

export const getStaticPaths: GetStaticPaths = async () => {
	const haikus = await getCollection("haikus");
	const etiquetas = [
		...new Set(haikus.map((haiku) => haiku.data.tags).flatMap((etiquetas) => etiquetas)),
	].filter((etiqueta) => etiqueta !== undefined);

	return etiquetas.map((etiqueta) => ({
		params: { etiqueta },
		props: { haikus: haikus.filter((haiku) => haiku.data.tags?.includes(etiqueta)) },
	}));
};

type Props = { haikus: CollectionEntry<"haikus">[] };

const fondosArtisticos = [BgTanuki, BgLamparas, BgTemplo, BgOrigamis, BgJ];
const { haikus } = Astro.props;
const HaikusComponents = await Promise.all(
	(haikus as CollectionEntry<"haikus">[]).map(async (haiku) => await render(haiku)),
);

// Get current tag from URL
const currentTag = Astro.params.etiqueta as string;
const tagTitle = `Haikus con etiqueta: ${currentTag}`;
const tagDescription = `Colección de haikus etiquetados como "${currentTag}". Descubre poesía haiku sobre este tema específico.`;
const tagKeywords = `haiku, ${currentTag}, poesía, etiqueta, literatura`;
---

<EstructuraBaseParaTodoElSitio
	titulo={tagTitle}
	descripcion={tagDescription}
	keywords={tagKeywords}
	type="website"
>
	<EstructuraParaEfectoReel>
		{
			haikus.map((haiku, index) => {
				const FondoArtistico = fondosArtisticos[index % fondosArtisticos.length];
				const { Content: Haiku } = HaikusComponents[index];
				const { autoria, pubDate, tags } = haiku.data;
				return (
					<SeccionParaCadaHaikuReel>
						<FondoArtistico>
							<ArticuloParaCadaHaiku autoria={autoria} pubDate={pubDate} tags={tags}>
								<Haiku />
							</ArticuloParaCadaHaiku>
						</FondoArtistico>
					</SeccionParaCadaHaikuReel>
				);
			})
		}
	</EstructuraParaEfectoReel>
</EstructuraBaseParaTodoElSitio>
